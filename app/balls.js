var Physics = require("./physics/physicsjs-full");
var LINK_STIFFNESS = 0.5;
function createLinkNode(x, y) {
    return Physics.body('circle', {
        x: x,
        y: y,
        radius: 2,
        mass: 0.1,
        styles: { image: "~/images/link.png" }
    });
}
function createLink(body1, body2, world, constraints, linkLength) {
    if (linkLength === void 0) { linkLength = 8; }
    var body1X = body1.state.pos.x;
    var body1Y = body1.state.pos.y;
    var body2X = body2.state.pos.x;
    var body2Y = body2.state.pos.y;
    var dx = body2X - body1X;
    var dy = body2Y - body1Y;
    var distance = Math.sqrt(dx * dx + dy * dy) - body1.radius - body2.radius;
    if (distance < 0) {
        throw Error("Bodies are too close");
    }
    var count = Math.floor(distance / linkLength) - 1;
    if (count === 0) {
        //direct link
        constraints.distanceConstraint(body1, body2, 0.5);
        return;
    }
    var angle = Math.atan2(dx, dy);
    var sin = Math.sin(angle);
    var cos = Math.cos(angle);
    var startX = body1X + body1.radius * sin;
    var startY = body1Y + body1.radius * cos;
    var xInc = (sin * distance) / (count + 1);
    var yInc = (cos * distance) / (count + 1);
    var links = [];
    for (var i = 0; i < count; i++) {
        var link = createLinkNode(startX + (i + 1) * xInc, startY + (i + 1) * yInc);
        links.push(link);
        world.add(link);
        if (i > 0) {
            constraints.distanceConstraint(links[i - 1], links[i], LINK_STIFFNESS);
        }
    }
    constraints.distanceConstraint(body1, links[0], LINK_STIFFNESS);
    constraints.distanceConstraint(links[count - 1], body2, LINK_STIFFNESS);
}
function createBallWithChain(bwc, world, constraints) {
    var ball = Physics.body('circle', {
        x: bwc.ballX,
        y: bwc.ballY,
        radius: 15,
        mass: 2,
        restitution: 0.3,
        styles: {
            image: bwc.image
        }
    });
    var anchor = Physics.body('circle', {
        x: bwc.anchorX,
        y: bwc.anchorY,
        vx: .2,
        radius: 10,
        mass: 9,
        restitution: 0.3,
        styles: {
            image: "~/images/anchor.png"
        }
    });
    anchor.treatment = 'static';
    bwc.anchorRef = anchor;
    createLink(anchor, ball, world, constraints);
    world.add(anchor);
    world.add(ball);
}
function initPhysicsWorld(container, metaText, ballsWithChains) {
    var world = Physics();
    var rigidConstraints = Physics.behavior('verlet-constraints', {
        iterations: 1
    });
    ballsWithChains.forEach(function (bwc) { return createBallWithChain(bwc, world, rigidConstraints); });
    world.add(rigidConstraints);
    var renderer = Physics.renderer('ns', {
        container: container,
        metaText: metaText,
        // width: SCENE_WIDTH,
        // height: SCENE_HEIGHT,
        meta: true
    });
    world.add([
        // Physics.behavior('edge-collision-detection', { aabb: Physics.aabb(0, 0, WIDTH, HEIGHT) }),
        Physics.behavior('body-collision-detection'),
        Physics.behavior('body-impulse-response'),
        Physics.behavior('sweep-prune'),
        Physics.behavior('constant-acceleration'),
        renderer
    ]);
    world.on('step', function () {
        world.render();
    });
    Physics.util.ticker.on(function (t) {
        world.step(t);
    }).start();
    setInterval(function () {
        world.step(Date.now());
    }, 20);
}
exports.initPhysicsWorld = initPhysicsWorld;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFsbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJiYWxscy50cyJdLCJuYW1lcyI6WyJjcmVhdGVMaW5rTm9kZSIsImNyZWF0ZUxpbmsiLCJjcmVhdGVCYWxsV2l0aENoYWluIiwiaW5pdFBoeXNpY3NXb3JsZCJdLCJtYXBwaW5ncyI6IkFBRUEsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUE7QUFFakQsSUFBSSxjQUFjLEdBQVcsR0FBRyxDQUFDO0FBV2pDLHdCQUF3QixDQUFTLEVBQUUsQ0FBUztJQUN4Q0EsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUE7UUFDMUJBLENBQUNBLEVBQUVBLENBQUNBO1FBQ0pBLENBQUNBLEVBQUVBLENBQUNBO1FBQ0pBLE1BQU1BLEVBQUVBLENBQUNBO1FBQ1RBLElBQUlBLEVBQUVBLEdBQUdBO1FBQ1RBLE1BQU1BLEVBQUVBLEVBQUVBLEtBQUtBLEVBQUVBLG1CQUFtQkEsRUFBRUE7S0FDekNBLENBQUNBLENBQUNBO0FBQ1BBLENBQUNBO0FBRUQsb0JBQW9CLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxVQUFzQjtJQUF0QkMsMEJBQXNCQSxHQUF0QkEsY0FBc0JBO0lBQ3hFQSxJQUFJQSxNQUFNQSxHQUFHQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUMvQkEsSUFBSUEsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDL0JBLElBQUlBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO0lBQy9CQSxJQUFJQSxNQUFNQSxHQUFHQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUUvQkEsSUFBSUEsRUFBRUEs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